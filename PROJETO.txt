import pandas as pd
import requests
import json
from io import BytesIO

# --- CARREGAMENTO DE DADOS ---
url_txt = "https://raw.githubusercontent.com/Thiago-Yukio/Cria-o-do-Primeiro-Agente-Virtual-na-DIO/main/dados/formulas_financeiras_basicas.txt"
response_txt = requests.get(url_txt)
response_txt.raise_for_status()
conteudo_txt = response_txt.text

url_xlsx = "https://raw.githubusercontent.com/Thiago-Yukio/Cria-o-do-Primeiro-Agente-Virtual-na-DIO/main/dados/planilhas_transacoes_ficticias.xlsx"
response_xlsx = requests.get(url_xlsx)
response_xlsx.raise_for_status()

arquivo_excel = BytesIO(response_xlsx.content)
df_transacoes = pd.read_excel(arquivo_excel)

# --- DADOS CLIENTE ---

perfil = {
    "nome": "Cliente Exemplo",
    "idade": 30,
    "perfil_investidor": "Moderado",
    "objetivo_principal": "Aumentar patrimônio",
    "patrimonio_total": 50000,
    "reserva_emergencia_atual": 10000
}
historico = pd.DataFrame({
    "data": ["2026-01-10", "2026-02-05"],
    "assunto": ["Análise de gastos", "Dúvida sobre CDI"]
})
produtos = [
    {"nome": "CDB 100% CDI", "tipo": "Renda Fixa"},
    {"nome": "Fundo Multimercado", "tipo": "Renda Variável"}
]

# --- MONTAGEM ---

contexto = f"""
### CONHECIMENTO BASE (FÓRMULAS):
{conteudo_txt}
### PERFIL DO CLIENTE:
CLIENTE: {perfil['nome']}, {perfil['idade']} anos, perfil {perfil['perfil_investidor']}
OBJETIVO: {perfil['objetivo_principal']}
PATRIMÔNIO: R$ {perfil['patrimonio_total']} | RESERVA: R$ {perfil['reserva_emergencia_atual']}
### TRANSAÇÕES RECENTES (Extraídas da Planilha):
{df_transacoes.head(10).to_string(index=False)}
### HISTÓRICO DE ATENDIMENTO:
{historico.to_string(index=False)}
### PRODUTOS DISPONÍVEIS:
{json.dumps(produtos, indent=2, ensure_ascii=False)}
"""

# --- SYSTEM_PROMPT ---

SYSTEM_PROMPT = """Você é o IA-Nodex o analista finaceiro

Objetivo:
O IA-Nodex realiza análises financeiras básicas a partir de dados fornecidos (Excel, CSV ou JSON), como cálculo de lucro e indicadores essenciais, explicando os resultados de forma simples para usuários leigos.

Regras:
- Analisa apenas os dados enviados pelo usuário.
- Não cria nem assume informações.
- Não faz recomendações de investimento.
- Não acessa dados bancários sensíveis.
- Não substitui profissional financeiro.
- Se os dados forem insuficientes ou inconsistentes, informa a limitação.
"""